<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RuralMind Connect | Healthcare Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Previous CSS remains the same, adding new styles for API integration */
        
        .api-settings {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
        }
        
        .api-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-connected {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-disconnected {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .disclaimer {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 6px;
            border-left: 4px solid #ffc107;
        }
        
        .api-key-input {
            font-family: monospace;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Previous HTML structure remains the same until the AI Chat Modal -->

    <!-- Modal for AI Chat -->
    <div class="modal" id="ai-chat-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">AI Health Assistant</h3>
                <button class="close-modal" onclick="closeModal('ai-chat-modal')">&times;</button>
            </div>
            <div id="ai-chat-content">
                <!-- API Settings Section -->
                <div class="api-settings">
                    <h4>AI Configuration</h4>
                    <div class="form-group">
                        <label for="api-provider">AI Provider</label>
                        <select id="api-provider" onchange="toggleApiKeyField()">
                            <option value="gemini">Google Gemini</option>
                            <option value="openai">OpenAI GPT</option>
                            <option value="custom">Custom API</option>
                            <option value="local">Local Model</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="api-key-group">
                        <label for="api-key">API Key</label>
                        <input type="password" id="api-key" class="api-key-input" placeholder="Enter your API key">
                        <small class="muted">Your API key is stored locally and never shared</small>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-small" onclick="testApiConnection()">
                            <i class="fas fa-plug"></i> Test Connection
                        </button>
                        <button class="btn btn-small btn-secondary" onclick="saveApiSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                    
                    <div id="api-status-display">
                        <span class="api-status status-disconnected" id="api-status">
                            <i class="fas fa-times-circle"></i> Not Connected
                        </span>
                    </div>
                </div>

                <div class="disclaimer">
                    <strong>Disclaimer:</strong> This AI assistant provides general health information only. 
                    It is not a substitute for professional medical advice. Always consult healthcare 
                    providers for medical conditions.
                </div>

                <div class="chat-container">
                    <div class="chat-messages" id="ai-chat-messages">
                        <div class="message ai">
                            <div class="ai-indicator">
                                <i class="fas fa-robot"></i> AI Health Assistant
                            </div>
                            Hello! I'm your AI Health Assistant powered by advanced medical AI. 
                            I can help with:
                            <br>• Symptom analysis and triage
                            <br>• Medication information
                            <br>• First aid guidance
                            <br>• Health education
                            <br>• Preventive care advice
                            <br><br>Please configure your API settings above for enhanced responses.
                            How can I assist you today?
                        </div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="ai-chat-input" placeholder="Describe your symptoms or ask a health question...">
                        <button class="btn" onclick="sendAIMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== AI CHAT SYSTEM WITH API INTEGRATION ====================
        
        // API Configuration
        let apiConfig = {
            provider: 'gemini',
            apiKey: '',
            baseURL: '',
            isConnected: false
        };

        // Load API settings from localStorage
        function loadApiSettings() {
            try {
                const saved = localStorage.getItem('rmc_ai_settings');
                if (saved) {
                    const config = JSON.parse(saved);
                    apiConfig = { ...apiConfig, ...config };
                    
                    // Update UI
                    document.getElementById('api-provider').value = apiConfig.provider;
                    document.getElementById('api-key').value = apiConfig.apiKey;
                    updateApiStatus();
                }
            } catch (e) {
                console.error('Error loading API settings:', e);
            }
        }

        // Save API settings to localStorage
        function saveApiSettings() {
            apiConfig.provider = document.getElementById('api-provider').value;
            apiConfig.apiKey = document.getElementById('api-key').value;
            
            localStorage.setItem('rmc_ai_settings', JSON.stringify(apiConfig));
            alert('API settings saved successfully!');
            updateApiStatus();
        }

        // Toggle API key field based on provider
        function toggleApiKeyField() {
            const provider = document.getElementById('api-provider').value;
            const apiKeyGroup = document.getElementById('api-key-group');
            
            if (provider === 'local') {
                apiKeyGroup.style.display = 'none';
            } else {
                apiKeyGroup.style.display = 'block';
            }
        }

        // Test API connection
        async function testApiConnection() {
            const testButton = document.querySelector('#api-settings .btn');
            const originalText = testButton.innerHTML;
            
            testButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            testButton.disabled = true;
            
            try {
                // Simple test message to verify API connectivity
                const testResponse = await callMedicalAI('Hello, please respond with "Connected" if you can read this.');
                
                if (testResponse && testResponse.includes('Connected')) {
                    apiConfig.isConnected = true;
                    alert('API connection successful!');
                } else {
                    throw new Error('Invalid response from API');
                }
            } catch (error) {
                apiConfig.isConnected = false;
                alert('API connection failed: ' + error.message);
            }
            
            updateApiStatus();
            testButton.innerHTML = originalText;
            testButton.disabled = false;
        }

        // Update API status display
        function updateApiStatus() {
            const statusElement = document.getElementById('api-status');
            if (apiConfig.isConnected && apiConfig.apiKey) {
                statusElement.className = 'api-status status-connected';
                statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Connected';
            } else {
                statusElement.className = 'api-status status-disconnected';
                statusElement.innerHTML = '<i class="fas fa-times-circle"></i> Not Connected';
            }
        }

        // Main AI message sending function
        async function sendAIMessage() {
            const input = document.getElementById('ai-chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            const chatMessages = document.getElementById('ai-chat-messages');
            
            // Add user message
            const userMessageElement = document.createElement('div');
            userMessageElement.className = 'message sent';
            userMessageElement.textContent = message;
            chatMessages.appendChild(userMessageElement);
            
            input.value = '';
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Show typing indicator
            const typingElement = document.createElement('div');
            typingElement.className = 'message ai';
            typingElement.innerHTML = `
                <div class="ai-indicator">
                    <i class="fas fa-robot"></i> AI Assistant
                </div>
                <i class="fas fa-ellipsis-h"></i> Analyzing your query...
            `;
            chatMessages.appendChild(typingElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            try {
                let aiResponse;
                
                // Use API if configured, otherwise use fallback
                if (apiConfig.isConnected && apiConfig.apiKey) {
                    aiResponse = await callMedicalAI(message);
                } else {
                    aiResponse = generateFallbackResponse(message);
                }
                
                // Remove typing indicator
                chatMessages.removeChild(typingElement);
                
                const aiMessageElement = document.createElement('div');
                aiMessageElement.className = 'message ai';
                aiMessageElement.innerHTML = `
                    <div class="ai-indicator">
                        <i class="fas fa-robot"></i> AI Assistant
                        ${apiConfig.isConnected ? '<span style="margin-left: 10px; font-size: 0.7em; color: var(--success);">✓ API</span>' : '<span style="margin-left: 10px; font-size: 0.7em; color: var(--gray);">✓ Basic</span>'}
                    </div>
                    ${aiResponse}
                    <div class="disclaimer" style="margin-top: 10px; font-size: 0.7rem;">
                        <strong>Note:</strong> This is AI-generated information. Always consult healthcare professionals for medical advice.
                    </div>
                `;
                
                chatMessages.appendChild(aiMessageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
            } catch (error) {
                // Remove typing indicator
                chatMessages.removeChild(typingElement);
                
                const errorMessageElement = document.createElement('div');
                errorMessageElement.className = 'message ai';
                errorMessageElement.innerHTML = `
                    <div class="ai-indicator">
                        <i class="fas fa-robot"></i> AI Assistant
                    </div>
                    I apologize, but I'm having trouble connecting to the medical AI service. 
                    <br><br>
                    <strong>Possible solutions:</strong>
                    <br>• Check your API configuration
                    <br>• Verify your internet connection
                    <br>• Try again in a few moments
                    <br><br>
                    <button class="btn btn-small" onclick="openApiSettings()">
                        <i class="fas fa-cog"></i> Check API Settings
                    </button>
                `;
                
                chatMessages.appendChild(errorMessageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                console.error('AI API Error:', error);
            }
        }

        // Call external medical AI API
        async function callMedicalAI(userMessage) {
            const provider = apiConfig.provider;
            const apiKey = apiConfig.apiKey;
            
            // Medical context prompt
            const medicalPrompt = `You are a medical AI assistant. Provide helpful, accurate, and safe health information.
            
IMPORTANT GUIDELINES:
- Be factual and evidence-based
- Always recommend consulting healthcare professionals
- Identify emergency situations clearly
- Provide practical first-aid advice when appropriate
- Be clear about limitations of AI in medical diagnosis
- Use simple, understandable language

User Query: ${userMessage}

Please provide a comprehensive, helpful response that follows medical best practices.`;

            try {
                switch (provider) {
                    case 'gemini':
                        return await callGeminiAPI(medicalPrompt, apiKey);
                    
                    case 'openai':
                        return await callOpenAIAPI(medicalPrompt, apiKey);
                    
                    case 'custom':
                        return await callCustomAPI(medicalPrompt, apiKey);
                    
                    case 'local':
                        return await callLocalAPI(medicalPrompt);
                    
                    default:
                        throw new Error('Unsupported API provider');
                }
            } catch (error) {
                throw new Error(`API call failed: ${error.message}`);
            }
        }

        // Google Gemini API Integration
        async function callGeminiAPI(prompt, apiKey) {
            // Note: This is a simplified example. You'll need to use the actual Gemini API
            const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`Gemini API error: ${response.status}`);
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // OpenAI GPT API Integration
        async function callOpenAIAPI(prompt, apiKey) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-3.5-turbo',
                    messages: [
                        {
                            role: 'system',
                            content: 'You are a helpful medical AI assistant. Provide accurate health information while always recommending professional medical consultation for serious concerns.'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 1000,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`OpenAI API error: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // Custom API Integration
        async function callCustomAPI(prompt, apiKey) {
            // Replace with your custom API endpoint
            const response = await fetch(apiConfig.baseURL || 'YOUR_CUSTOM_API_ENDPOINT', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    prompt: prompt,
                    max_tokens: 1000
                })
            });

            if (!response.ok) {
                throw new Error(`Custom API error: ${response.status}`);
            }

            const data = await response.json();
            return data.response || data.answer || data.text;
        }

        // Local model fallback
        async function callLocalAPI(prompt) {
            // Simulate local processing delay
            await new Promise(resolve => setTimeout(resolve, 1000));
            return generateFallbackResponse(prompt);
        }

        // Fallback response generator (when no API available)
        function generateFallbackResponse(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            
            // Enhanced fallback responses
            if (lowerMessage.includes('fever') || lowerMessage.includes('temperature')) {
                return `For fever management:
<br><br><strong>Immediate Care:</strong>
• Rest in a cool environment
• Drink plenty of fluids (water, electrolyte solutions)
• Take acetaminophen or ibuprofen as directed
• Use cool compresses on forehead and wrists

<strong>Monitor for Emergency Signs:</strong>
• Fever above 103°F (39.4°C)
• Fever lasting more than 3 days
• Stiff neck, severe headache, or confusion
• Difficulty breathing
• Seizures

<strong>When to Seek Medical Care:</strong>
• Infants under 3 months with any fever
• Children with fever and lethargy
• Adults with underlying health conditions

<strong>Important:</strong> This is general advice. Consult a healthcare provider for proper diagnosis and treatment.`;
            
            } else if (lowerMessage.includes('headache')) {
                return `For headache relief:
<br><br><strong>Self-Care Measures:</strong>
• Rest in a quiet, dark room
• Apply cold compress to forehead
• Stay hydrated
• Practice relaxation techniques
• Consider OTC pain relievers (follow dosage instructions)

<strong>Types of Headaches:</strong>
• Tension headaches: Pressure around forehead
• Migraines: Throbbing pain, often with nausea
• Cluster headaches: Severe pain around one eye

<strong>Seek Immediate Medical Attention for:</strong>
• Sudden, severe "thunderclap" headache
• Headache after head injury
• Headache with fever, stiff neck, or confusion
• Headache with vision changes or weakness

<strong>Consult a doctor for persistent or worsening headaches.</strong>`;
            
            } else if (lowerMessage.includes('cough') || lowerMessage.includes('cold')) {
                return `For cough and cold symptoms:
<br><br><strong>Symptom Relief:</strong>
• Drink warm fluids (tea with honey, broth)
• Use a humidifier
• Gargle with salt water
• Get adequate rest
• Use saline nasal spray

<strong>Medication Considerations:</strong>
• Cough suppressants for dry cough
• Expectorants for productive cough
• Decongestants for nasal congestion
• Always follow package instructions

<strong>When to See a Doctor:</strong>
• Symptoms lasting more than 10 days
• High fever (above 102°F/39°C)
• Difficulty breathing or wheezing
• Chest pain
• Bluish lips or face

<strong>Prevention:</strong>
• Frequent hand washing
• Avoid close contact with sick individuals
• Stay home when symptomatic`;
            
            } else {
                return `Thank you for your question about "${userMessage}". 

<strong>For the most accurate and personalized medical information, I recommend:</strong>

1. <strong>Consulting a Healthcare Professional:</strong> They can provide proper diagnosis and treatment based on your specific situation.

2. <strong>Emergency Services:</strong> If this is an emergency, please call your local emergency number immediately.

3. <strong>Reliable Health Resources:</strong>
   • CDC (Centers for Disease Control and Prevention)
   • WHO (World Health Organization)
   • Mayo Clinic
   • WebMD

<strong>Would you like me to help you:</strong>
• Find a nearby healthcare provider?
• Schedule a telemedicine appointment?
• Provide general health education on specific topics?

<em>Note: For enhanced AI responses with up-to-date medical information, please configure your API settings above.</em>`;
            }
        }

        // Open API settings
        function openApiSettings() {
            const aiModal = document.getElementById('ai-chat-modal');
            if (aiModal.style.display === 'flex') {
                // Scroll to settings section
                document.querySelector('.api-settings').scrollIntoView({ behavior: 'smooth' });
            } else {
                openAIChat();
            }
        }

        // Initialize API settings when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadApiSettings();
            toggleApiKeyField();
            
            // Add Enter key support for AI chat
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && document.getElementById('ai-chat-input')) {
                    const chatInput = document.getElementById('ai-chat-input');
                    if (document.activeElement === chatInput) {
                        sendAIMessage();
                    }
                }
            });
        });

        // Previous code for other functionality remains the same...
        // ==================== REST OF YOUR EXISTING CODE ====================
    </script>
</body>
</html>
